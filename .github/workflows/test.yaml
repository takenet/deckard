name: CI

on: [pull_request]

env:
  GO_VERSION: 1.18

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6.0
        ports:
        - 27017:27017

      redis:
        image: redis:7.0
        ports:
        - 6379:6379

    steps:
    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ env.GO_VERSION }}
      
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Go mod tidy
      run: go mod tidy

    - name: Make gen-proto
      run: make gen-proto

    - name: Make test
      run: make test

    - name: Upload test results
      uses: actions/upload-artifact@v2
      with:
        name: junit-report
        path: junit.xml

    - name: JUnit report action
      uses: mikepenz/action-junit-report@v3
      if: always()
      with:
        report_paths: junit.xml